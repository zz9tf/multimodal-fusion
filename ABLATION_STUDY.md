# Ablation Study å®éªŒæŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬ç›®å½•åŒ…å« 7 ä¸ªç‹¬ç«‹çš„ ablation study è„šæœ¬ï¼Œç”¨äºç³»ç»Ÿæ€§åœ°è¯„ä¼°ä¸åŒè¶…å‚æ•°å¯¹æ¨¡å‹æ€§èƒ½çš„å½±å“ã€‚æ¯ä¸ªè„šæœ¬æµ‹è¯•ä¸€ä¸ªå‚æ•°çš„ 10 ä¸ªä¸åŒå€¼ã€‚

## ğŸ“‚ è„šæœ¬åˆ—è¡¨

| è„šæœ¬æ–‡ä»¶ | æµ‹è¯•å‚æ•° | æµ‹è¯•å€¼æ•°é‡ | å‚æ•°èŒƒå›´ |
|---------|---------|-----------|---------|
| `ablation_mismatch_ratio.sh` | è´Ÿæ ·æœ¬æ¯”ä¾‹ | 10 | 0.1 ~ 10.0 |
| `ablation_seed.sh` | éšæœºç§å­ | 10 | 42 ~ 9999 |
| `ablation_lambda1.sh` | å¯¹æ¯”æŸå¤±æƒé‡ | 10 | 0.0 ~ 5.0 |
| `ablation_lambda2.sh` | åŒ¹é…é¢„æµ‹æŸå¤±æƒé‡ | 10 | 0.0 ~ 0.5 |
| `ablation_tau1.sh` | æ¸©åº¦å‚æ•°1 | 10 | 0.01 ~ 1.0 |
| `ablation_tau2.sh` | æ¸©åº¦å‚æ•°2 | 10 | 0.01 ~ 0.5 |
| `ablation_num_layers.sh` | å¯¹é½å±‚æ•° | 10 | 1 ~ 10 |

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æ–¹å¼ 1: è¿è¡Œå•ä¸ª Ablation Study

```bash
# ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
chmod +x ablation_mismatch_ratio.sh

# è¿è¡Œå•ä¸ªå®éªŒ
./ablation_mismatch_ratio.sh
```

### æ–¹å¼ 2: è¿è¡Œæ‰€æœ‰ Ablation Studies

```bash
# ç»™ä¸»è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
chmod +x run_all_ablations.sh

# è¿è¡Œæ‰€æœ‰å®éªŒï¼ˆâš ï¸ éœ€è¦å¾ˆé•¿æ—¶é—´ï¼‰
./run_all_ablations.sh
```

### æ–¹å¼ 3: åå°è¿è¡Œ

```bash
# åå°è¿è¡Œå¹¶ä¿å­˜æ—¥å¿—
nohup ./ablation_mismatch_ratio.sh > logs/ablation_mismatch_ratio.log 2>&1 &

# æŸ¥çœ‹è¿›åº¦
tail -f logs/ablation_mismatch_ratio.log
```

## ğŸ“Š å®éªŒé…ç½®

### å›ºå®šå‚æ•°ï¼ˆæ‰€æœ‰å®éªŒå…±ç”¨ï¼‰

```bash
MAX_STEPS=10000          # è®­ç»ƒæ­¥æ•°
BATCH_SIZE=64            # æ‰¹æ¬¡å¤§å°
LEARNING_RATE=1e-4       # å­¦ä¹ ç‡
WEIGHT_DECAY=1e-5        # æƒé‡è¡°å‡
LOG_INTERVAL=100         # æ—¥å¿—é—´éš”
VAL_INTERVAL=500         # éªŒè¯é—´éš”
```

### é»˜è®¤å‚æ•°å€¼

```bash
MISMATCH_RATIO=1.0       # è´Ÿæ ·æœ¬æ¯”ä¾‹
SEED=42                  # éšæœºç§å­
LAMBDA1=1.0              # å¯¹æ¯”æŸå¤±æƒé‡
LAMBDA2=0.1              # åŒ¹é…é¢„æµ‹æŸå¤±æƒé‡
TAU1=0.1                 # æ¸©åº¦å‚æ•°1
TAU2=0.05                # æ¸©åº¦å‚æ•°2
NUM_LAYERS=2             # å¯¹é½å±‚æ•°
```

## ğŸ“ ç»“æœç›®å½•ç»“æ„

```
results/
â”œâ”€â”€ ablation_mismatch_ratio/
â”‚   â”œâ”€â”€ model_ratio_0.1.pth
â”‚   â”œâ”€â”€ model_ratio_0.1.history.json
â”‚   â”œâ”€â”€ model_ratio_0.3.pth
â”‚   â”œâ”€â”€ model_ratio_0.3.history.json
â”‚   â””â”€â”€ ...
â”œâ”€â”€ ablation_seed/
â”‚   â”œâ”€â”€ model_seed_42.pth
â”‚   â”œâ”€â”€ model_seed_42.history.json
â”‚   â””â”€â”€ ...
â”œâ”€â”€ ablation_lambda1/
â”œâ”€â”€ ablation_lambda2/
â”œâ”€â”€ ablation_tau1/
â”œâ”€â”€ ablation_tau2/
â””â”€â”€ ablation_num_layers/
```

æ¯ä¸ªå®éªŒä¼šç”Ÿæˆï¼š
- `.pth` æ–‡ä»¶ï¼šæœ€ä½³æ¨¡å‹æƒé‡
- `.history.json` æ–‡ä»¶ï¼šè®­ç»ƒå†å²ï¼ˆlossã€SVDå€¼ç­‰ï¼‰

## ğŸ“ˆ å‚æ•°è¯´æ˜

### 1. `mismatch_ratio` - è´Ÿæ ·æœ¬æ¯”ä¾‹

**ä½œç”¨**: æ§åˆ¶è´Ÿæ ·æœ¬æ•°é‡ä¸æ­£æ ·æœ¬çš„æ¯”ä¾‹

**æµ‹è¯•å€¼**: `0.1, 0.3, 0.5, 0.7, 1.0, 1.5, 2.0, 3.0, 5.0, 10.0`

**é¢„æœŸå½±å“**:
- è¿‡å°ï¼šæ¨¡å‹éš¾ä»¥å­¦ä¹ åŒºåˆ†åŒ¹é…/ä¸åŒ¹é…æ ·æœ¬
- è¿‡å¤§ï¼šè®­ç»ƒæ—¶é—´å¢åŠ ï¼Œå¯èƒ½å¼•å…¥å™ªå£°
- æœ€ä¼˜å€¼ï¼šé€šå¸¸åœ¨ 0.5-2.0 ä¹‹é—´

### 2. `seed` - éšæœºç§å­

**ä½œç”¨**: è¯„ä¼°æ¨¡å‹ç¨³å®šæ€§å’Œå¯é‡å¤æ€§

**æµ‹è¯•å€¼**: `42, 123, 456, 789, 1024, 2048, 3141, 5926, 8888, 9999`

**é¢„æœŸå½±å“**:
- ä¸åŒ seed çš„ç»“æœå˜åŒ–è¶Šå°ï¼Œæ¨¡å‹è¶Šç¨³å®š
- ç”¨äºè®¡ç®—å¹³å‡æ€§èƒ½å’Œæ ‡å‡†å·®

### 3. `lambda1` - å¯¹æ¯”æŸå¤±æƒé‡

**ä½œç”¨**: æ§åˆ¶ SVD ç§©çº¦æŸçš„é‡è¦æ€§

**æµ‹è¯•å€¼**: `0.0, 0.1, 0.3, 0.5, 0.7, 1.0, 1.5, 2.0, 3.0, 5.0`

**é¢„æœŸå½±å“**:
- 0.0: å®Œå…¨ä¸ä½¿ç”¨å¯¹æ¯”æŸå¤±
- è¿‡å°ï¼šå¯¹é½æ•ˆæœä¸ä½³
- è¿‡å¤§ï¼šå¯èƒ½å¯¼è‡´æ”¶æ•›å›°éš¾

### 4. `lambda2` - åŒ¹é…é¢„æµ‹æŸå¤±æƒé‡

**ä½œç”¨**: æ§åˆ¶è´Ÿæ ·æœ¬åˆ¤åˆ«çš„é‡è¦æ€§

**æµ‹è¯•å€¼**: `0.0, 0.01, 0.03, 0.05, 0.07, 0.1, 0.15, 0.2, 0.3, 0.5`

**é¢„æœŸå½±å“**:
- 0.0: å®Œå…¨ä¸ä½¿ç”¨åŒ¹é…é¢„æµ‹æŸå¤±
- è¿‡å°ï¼šéš¾ä»¥åŒºåˆ†æ­£è´Ÿæ ·æœ¬
- è¿‡å¤§ï¼šå¯èƒ½åå‘åˆ¤åˆ«ä»»åŠ¡ï¼Œå¿½ç•¥å¯¹é½

### 5. `tau1` - SVD æ¸©åº¦å‚æ•°

**ä½œç”¨**: æ§åˆ¶ SVD æŸå¤±çš„å¹³æ»‘åº¦

**æµ‹è¯•å€¼**: `0.01, 0.03, 0.05, 0.07, 0.1, 0.15, 0.2, 0.3, 0.5, 1.0`

**é¢„æœŸå½±å“**:
- è¿‡å°ï¼šæŸå¤±è¿‡äºé™¡å³­ï¼Œä¼˜åŒ–å›°éš¾
- è¿‡å¤§ï¼šæŸå¤±è¿‡äºå¹³æ»‘ï¼Œæ”¶æ•›æ…¢

### 6. `tau2` - å¯¹æ¯”å­¦ä¹ æ¸©åº¦å‚æ•°

**ä½œç”¨**: æ§åˆ¶å¯¹æ¯”æŸå¤±çš„å¹³æ»‘åº¦

**æµ‹è¯•å€¼**: `0.01, 0.02, 0.03, 0.05, 0.07, 0.1, 0.15, 0.2, 0.3, 0.5`

**é¢„æœŸå½±å“**:
- è¿‡å°ï¼šè¿‡äºå…³æ³¨å›°éš¾æ ·æœ¬
- è¿‡å¤§ï¼šå¿½ç•¥æ ·æœ¬é—´å·®å¼‚

### 7. `num_layers` - å¯¹é½å±‚æ•°

**ä½œç”¨**: æ§åˆ¶ç½‘ç»œæ·±åº¦å’Œè¡¨è¾¾èƒ½åŠ›

**æµ‹è¯•å€¼**: `1, 2, 3, 4, 5, 6, 7, 8, 9, 10`

**é¢„æœŸå½±å“**:
- 1å±‚ï¼šæœ€ç®€å•ï¼Œå¯èƒ½æ¬ æ‹Ÿåˆ
- 2-3å±‚ï¼šé€šå¸¸æœ€ä¼˜
- >5å±‚ï¼šå¯èƒ½è¿‡æ‹Ÿåˆæˆ–æ¢¯åº¦æ¶ˆå¤±

## ğŸ” ç»“æœåˆ†æ

### åˆ†æå•ä¸ªå®éªŒ

```python
import json
import matplotlib.pyplot as plt

# åŠ è½½è®­ç»ƒå†å²
with open('results/ablation_lambda1/model_lambda1_1.0.history.json') as f:
    history = json.load(f)

# è·å–æœ€ä½³éªŒè¯ loss
best_val_loss = min(history['val_losses'])
print(f"Best validation loss: {best_val_loss:.4f}")

# ç»˜åˆ¶è®­ç»ƒæ›²çº¿
plt.plot(history['val_losses'])
plt.show()
```

### å¯¹æ¯”æ‰€æœ‰å®éªŒ

```python
import json
import glob
import numpy as np
import matplotlib.pyplot as plt

# æ”¶é›†æ‰€æœ‰ lambda1 å®éªŒçš„ç»“æœ
results = {}
for f in glob.glob('results/ablation_lambda1/*.history.json'):
    with open(f) as file:
        history = json.load(file)
        lambda1 = history['config']['lambda1']
        best_loss = min(history['val_losses'])
        results[lambda1] = best_loss

# ç»˜åˆ¶å¯¹æ¯”å›¾
lambdas = sorted(results.keys())
losses = [results[l] for l in lambdas]
plt.plot(lambdas, losses, marker='o')
plt.xlabel('lambda1')
plt.ylabel('Best Validation Loss')
plt.title('Lambda1 Ablation Study')
plt.show()
```

## â±ï¸ æ—¶é—´ä¼°ç®—

å‡è®¾æ¯ä¸ªå®éªŒéœ€è¦ X åˆ†é’Ÿï¼ˆå–å†³äº `MAX_STEPS`ï¼‰ï¼š

- å•ä¸ª ablation study: 10 Ã— X åˆ†é’Ÿ
- æ‰€æœ‰ ablation studies: 70 Ã— X åˆ†é’Ÿ

**å»ºè®®**:
- å…ˆç”¨è¾ƒå°çš„ `MAX_STEPS` (å¦‚ 2000) å¿«é€Ÿæµ‹è¯•
- ç¡®è®¤ä»£ç æ— è¯¯åï¼Œå†ç”¨å®Œæ•´çš„æ­¥æ•°è¿è¡Œ

## ğŸ’¡ ä½¿ç”¨å»ºè®®

1. **ä¼˜å…ˆçº§æ’åº**: æ ¹æ®é¢„æœŸå½±å“ï¼Œä¼˜å…ˆè¿è¡Œé‡è¦å‚æ•°çš„ ablation
   - é«˜ä¼˜å…ˆçº§: `lambda1`, `lambda2`, `num_layers`
   - ä¸­ä¼˜å…ˆçº§: `tau1`, `tau2`, `mismatch_ratio`
   - ä½ä¼˜å…ˆçº§: `seed` (ç”¨äºæœ€ç»ˆè¯„ä¼°)

2. **åˆ†æ‰¹è¿è¡Œ**: ä¸è¦ä¸€æ¬¡è¿è¡Œæ‰€æœ‰å®éªŒ
   - å…ˆè¿è¡Œ 1-2 ä¸ª ablation study
   - åˆ†æç»“æœåå†ç»§ç»­

3. **è°ƒæ•´å‚æ•°èŒƒå›´**: æ ¹æ®åˆæ­¥ç»“æœè°ƒæ•´æµ‹è¯•èŒƒå›´
   - å¦‚æœæœ€ä¼˜å€¼åœ¨è¾¹ç•Œï¼Œæ‰©å±•èŒƒå›´
   - å¦‚æœå˜åŒ–ä¸å¤§ï¼Œç¼©å°èŒƒå›´å¢åŠ ç²¾åº¦

4. **GPU èµ„æº**: å¯ä»¥ä¿®æ”¹è„šæœ¬ä½¿ç”¨ä¸åŒçš„ GPU
   ```bash
   # ç¼–è¾‘è„šæœ¬ï¼Œä¿®æ”¹ CUDA_VISIBLE_DEVICES
   CUDA_VISIBLE_DEVICES=0  # ä½¿ç”¨ GPU 0
   CUDA_VISIBLE_DEVICES=1  # ä½¿ç”¨ GPU 1
   ```

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜ï¼šè„šæœ¬æ— æ³•æ‰§è¡Œ
```bash
chmod +x ablation_*.sh
chmod +x run_all_ablations.sh
```

### é—®é¢˜ï¼šGPU å†…å­˜ä¸è¶³
- å‡å° `BATCH_SIZE`
- å‡å°‘ `num_layers`

### é—®é¢˜ï¼šç£ç›˜ç©ºé—´ä¸è¶³
- æ¯ä¸ªæ¨¡å‹çº¦ 100-200 MB
- 70 ä¸ªå®éªŒçº¦éœ€è¦ 7-14 GB

### é—®é¢˜ï¼šæƒ³è¦ä¸­æ–­æŸä¸ªå®éªŒ
```bash
# æŸ¥æ‰¾è¿›ç¨‹
ps aux | grep run.py

# ç»ˆæ­¢è¿›ç¨‹
kill -9 <PID>
```

## ğŸ“ æ€»ç»“

è¿™å¥— ablation study è„šæœ¬æä¾›äº†ï¼š
- âœ… 7 ä¸ªå…³é”®è¶…å‚æ•°çš„ç³»ç»Ÿæ€§è¯„ä¼°
- âœ… æ¯ä¸ªå‚æ•° 10 ä¸ªæµ‹è¯•å€¼
- âœ… è‡ªåŠ¨åŒ–è¿è¡Œå’Œç»“æœä¿å­˜
- âœ… æ¸…æ™°çš„ç›®å½•ç»“æ„

è¿è¡Œå®Œæˆåï¼Œä½ å°†è·å¾—å®Œæ•´çš„è¶…å‚æ•°åˆ†æï¼Œç”¨äºè®ºæ–‡ã€æŠ¥å‘Šæˆ–è¿›ä¸€æ­¥ä¼˜åŒ–ï¼

